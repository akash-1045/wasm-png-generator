# WebAssembly PNG Generator: Compiling libpng and zlib with Emscripten

This project demonstrates how to generate PNG images in the browser using WebAssembly by compiling `libpng` and `zlib` with Emscripten. It includes a simple C wrapper (`png_wrapper.c`) that converts raw RGB data into a PNG image fully in memory.

---

## Project Context and Workflow


1.  **Raw Data Generation (JavaScript):** In `index.html`, JavaScript draws a random image onto a canvas. This canvas data is then extracted as a raw RGB pixel array.
2.  **Data Transfer to WebAssembly:** This raw RGB data is passed to a WebAssembly function, `generate_png()`, which is exposed through the Emscripten-generated `png.js` glue code.
3.  **PNG Encoding (WebAssembly):** Inside WebAssembly (specifically, within `png_wrapper.c`), the `generate_png()` function utilizes the compiled `libpng` and `zlib` libraries.
    * `libpng` handles the PNG encoding process, taking the raw pixel data and structuring it into the PNG format.
    * `zlib` provides the necessary Deflate compression algorithm, which `libpng` internally uses to compress the pixel data efficiently.
    * The entire encoding process happens in memory, with `libpng`'s in-memory I/O support.
4.  **PNG Data Return (WebAssembly to JavaScript):** The WebAssembly function returns the fully encoded PNG data (as a byte array) back to JavaScript.
5.  **PNG Display (JavaScript):** JavaScript receives the PNG byte array, converts it into a `Blob` object, and then sets it as the source for an `<img>` element, rendering the generated PNG on the webpage.



---

## Project Structure and Explanation

```
wasm-libpng/
├── build.sh             # Script to build zlib, libpng, and png_wrapper to WebAssembly
├── zlib/                # Cloned zlib source code (for compression)
├── libpng/              # Cloned libpng source code (for PNG generation)
├── png_wrapper.c        # C wrapper to encode RGB data to PNG using libpng in memory
├── png.js               # Emscripten-generated JavaScript glue code
├── png.wasm             # Compiled WebAssembly binary for image generation
└── index.html           # Web UI to display canvas and rendered PNG image
```

---

### What Each File Does

#### `build.sh`

This shell script orchestrates the entire compilation process.
* It downloads (if not already present) and builds `zlib` and `libpng`.
* Finally, it compiles `png_wrapper.c` into a WebAssembly module with Emscripten.
* **Outputs:** `png.wasm` (the compiled WebAssembly binary) and `png.js` (the JavaScript glue code).

#### `zlib/`

Contains the source code for `zlib`, a widely-used data compression library.
* **Purpose:** `zlib` is crucial because PNG images use **Deflate compression**. `libpng` internally calls `zlib` to compress the raw pixel data before embedding it into the PNG file. Without `zlib`, `libpng` would not be able to generate valid, compressed PNGs.

#### `libpng/`

Contains the source code for `libpng`, the official PNG reference library.
* **Purpose:** `libpng` is responsible for the actual PNG encoding. It takes the uncompressed pixel data and, with the help of `zlib`, structures it into a standard PNG file format.

#### `png_wrapper.c`

C file that acts as a bridge between JavaScript code and the `libpng` library.
* **Defines:** A function named `generate_png()`.
* **Functionality:** This function accepts raw RGB pixel data, utilizes `libpng`'s in-memory I/O capabilities to encode this data directly into a PNG image within memory, and then returns the generated PNG byte array.

#### `png.js` and `png.wasm`

These are the core output files generated by Emscripten.
* **`png.wasm`:** The compiled WebAssembly binary. This file contains the low-level, highly optimized code for `libpng`, `zlib`, and `png_wrapper.c`. It's what actually performs the PNG encoding in the browser.
* **`png.js`:** The JavaScript "glue code" generated by Emscripten. This file provides the necessary JavaScript APIs to load `png.wasm` and allows your JavaScript code in `index.html` to call the C function `generate_png()` (and any other exposed C functions) as if it were a regular JavaScript function.

#### `index.html`

The main web page that demonstrates the project.
* **HTML Structure:** A simple webpage containing a `<canvas>` element (to draw the input RGB data) and an `<img>` element (to display the generated PNG).
* **JavaScript Logic (within `index.html`):**
    * Draws a random image onto the canvas.
    * Extracts the pixel data from the canvas as a raw RGB array.
    * Calls the `generate_png()` function from the loaded WebAssembly module (via `png.js`), passing the RGB data.
    * Receives the generated PNG data (as a byte array) from WebAssembly.
    * Creates a `Blob` from the PNG data and sets it as the `src` for the `<img>` tag, thereby displaying the generated PNG.


---

## How to Build and Run

### Prerequisites:

* **Emscripten SDK (emsdk):** Ensure you have the Emscripten SDK installed and activated. If not, follow the official Emscripten documentation for installation.
    ```bash
    source ~/emsdk/emsdk_env.sh
    ```

### Build:

1.  Navigate to the `wasm-libpng/` directory in your terminal.
2.  Make the `build.sh` script executable and run it:
    ```bash
    chmod +x build.sh
    ./build.sh
    ```
    This script will download `zlib` and `libpng` if they don't exist, then compile them along with `png_wrapper.c` into `png.wasm` and `png.js`.

### Run in Browser:

1.  Start a local web server from the `wasm-libpng/` directory. A simple Python server is sufficient:
    ```bash
    python3 -m http.server
    ```
2.  Open your web browser and navigate to: [http://localhost:8000](http://localhost:8000)
    You should see a canvas with a generated image and, the same image displayed as a PNG generated by WebAssembly.


---


References:

- https://github.com/pnggroup/libpng (libpng source)
- https://github.com/madler/zlib (zlib source)
- https://emscripten.org/docs/compiling/WebAssembly.html
- https://emscripten.org/docs/api_reference/preamble.js.html
- https://gist.github.com/niw/5963798 (libpng in-memory encoding example)
- https://stunlock.gg/posts/emscripten_with_cmake/
- https://github.com/emscripten-core/emscripten/issues/10412